{% extends "base.html" %}
{% load static %}

{% block title %}Kameralar boshqaruvi{% endblock %}

{% block content %}
    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-xl shadow-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">üé• IP Kameralar ro'yxati</h2>
        </div>

        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-2">
                üåê Tarmoqqa ulangan IP Kameralar
                <span class="text-sm text-gray-500 ml-2" id="cameraCount"></span>
            </h3>

            <div class="mb-4">
                <input type="text" id="cameraSearch" placeholder="üîç IP yoki matn bo‚Äòyicha qidirish..."
                       class="w-full border border-gray-300 rounded px-4 py-2 text-sm"
                       oninput="filterCameras()">
            </div>

            <div id="cameraLoader" class="flex justify-center py-10">
                <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-blue-500 border-solid"></div>
            </div>

            <div id="cameraList"
                 class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4 hidden"></div>
        </div>

        <div class="overflow-x-auto">
            <h3 class="text-lg font-medium text-gray-700 mb-2">üì¶ Saqlangan kameralar</h3>
            <table class="w-full table-auto border rounded text-sm">
                <thead class="bg-gray-100 text-left">
                <tr>
                    <th class="p-2 border">#</th>
                    <th class="p-2 border">Nomi</th>
                    <th class="p-2 border">Turi</th>
                    <th class="p-2 border">Manba</th>
                    <th class="p-2 border">Holati</th>
                    <th class="p-2 border">Tanlangan</th>
                    <th class="p-2 border">Amallar</th>
                </tr>
                </thead>
                <tbody id="savedCameraList"></tbody>
            </table>
        </div>
    </div>

    <!-- Kamera qo‚Äòshish modal (Yumshoq fadeIn animatsiyali) -->
    <div id="cameraModal"
         class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-xl animate-fadeIn w-full max-w-md">
            <div class="flex items-center justify-between mb-4 border-b pb-2">
                <h3 id="modalTitle" class="text-xl font-semibold text-gray-800">üì∑ IP Kamera qo‚Äòshish</h3>
                <button onclick="closeCameraModal()" class="text-gray-500 hover:text-red-500 text-lg font-bold">
                    &times;
                </button>
            </div>

            <form id="cameraForm" class="space-y-4">
                <input type="hidden" id="cameraIp" name="camera_ip">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kamera nomi</label>
                    <input type="text" id="cameraName" required placeholder="Masalan: Kirish eshigi"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Foydalanuvchi nomi</label>
                    <input type="text" id="cameraUsername" required placeholder="admin"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Parol</label>
                    <input type="password" id="cameraPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex justify-end gap-2 pt-4 border-t mt-4">
                    <button type="button" onclick="closeCameraModal()" class="text-sm text-gray-600 hover:text-red-600">
                        üö´ Bekor qilish
                    </button>
                    <button type="button" onclick="testLogin()"
                            class="hover:bg-blue-20 text-gray-600 px-4 py-2 text-sm rounded shadow">
                        üîç Tekshir
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Spinner -->
    <div id="modalLoader" class="hidden flex justify-center items-center py-2">
        <div class="animate-spin h-6 w-6 border-4 border-blue-500 border-t-transparent rounded-full"></div>
        <span class="ml-2 text-sm text-gray-600">Tekshirilmoqda...</span>
    </div>

    <!-- Kamera oqimi Modal -->
    <div id="streamModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center">
        <div class="relative bg-white rounded-2xl p-6 pt-12 w-full max-w-6xl shadow-lg">
            <!-- Yopish tugmasi (modal tashqarisida) -->
            <button onclick="closeStreamModal()"
                    class="absolute -top-4 right-6 bg-white text-gray-700 text-2xl font-bold rounded-full shadow p-2 hover:text-red-600 z-50">
                &times;
            </button>

            <div class="relative aspect-video overflow-hidden rounded-xl border border-gray-300 bg-black">
                <!-- üî• LIVE img (stream uchun) -->
                <img id="streamFrameImg" class="absolute inset-0 w-full h-full object-cover rounded" alt="Camera Stream"
                     style="z-index: 10;"/>

                <!-- üî• Replay video -->
                <video id="streamFrameVideo" class="absolute inset-0 w-full h-full object-cover rounded hidden" controls
                       preload="auto" style="z-index: 10;"></video>

                <!-- üî• Video boshqaruv tugmalari -->
                <div id="videoControls"
                     class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-3 items-center z-30 hidden">
                    <button onclick="seekVideo(-10)"
                            class="bg-black/70 text-white text-sm px-4 py-1 rounded-full hover:bg-black/90">
                        ‚è™ 10s
                    </button>
                    <button onclick="togglePlayPause()"
                            class="bg-black/70 text-white text-sm px-4 py-1 rounded-full hover:bg-black/90">
                        ‚ñ∂Ô∏è
                    </button>
                    <button onclick="seekVideo(10)"
                            class="bg-black/70 text-white text-sm px-4 py-1 rounded-full hover:bg-black/90">
                        10s ‚è©
                    </button>
                    <button onclick="toggleSpeed()"
                            class="bg-black/70 text-white text-sm px-4 py-1 rounded-full hover:bg-black/90">
                        1x
                    </button>
                </div>

                <!-- üî• Overlay badge'lar -->
                <div id="liveBadge"
                     class="absolute top-4 left-4 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow hidden z-20">
                    LIVE üî¥
                </div>
                <div id="cameraNameBadge"
                     class="absolute top-4 right-4 bg-black/70 text-white text-sm font-semibold px-3 py-1 rounded-full shadow z-20">
                    Kamera nomi
                </div>
                <div id="timeBadge"
                     class="absolute bottom-4 right-4 bg-black/70 text-white text-sm font-semibold px-3 py-1 rounded-full shadow z-20">
                    00:00:00
                </div>

                <!-- Yuklanmoqda Spinner -->
                <div id="streamLoading"
                     class="hidden absolute inset-0 flex items-center justify-center bg-white bg-opacity-70 text-gray-800 text-lg font-semibold rounded z-40">
                    ‚è≥ Yuklanmoqda...
                </div>

                <!-- Xatolik -->
                <div id="streamError"
                     class="hidden absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 text-red-600 text-lg font-semibold rounded z-40">
                    ‚ùå Kamera oqimini olishda xatolik yuz berdi
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        window.addEventListener("load", () => {
            fetch("/cameras/ajax-list/").then(res => res.json()).then(data => {
                const cameraList = document.getElementById("cameraList");
                const savedList = document.getElementById("savedCameraList");
                const cameraCount = document.getElementById("cameraCount");
                cameraList.innerHTML = "";
                savedList.innerHTML = "";
                cameraCount.innerText = `(${data.ip_cameras.length} ta topildi)`;

                data.ip_cameras.forEach(cam => {
                    const div = document.createElement("div");
                    div.className = "camera-card bg-white/30 backdrop-blur-md border border-white/30 shadow-lg rounded-2xl p-3 flex flex-col items-center text-center gap-1 hover:scale-105 transition";
                    div.innerHTML = `
                <div class="text-gray-800 font-medium text-sm">${cam.ip}</div>
                <div class="text-gray-500 text-xs">${cam.info}</div>
                <button onclick="openCameraModal('${cam.ip}')"
                    class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded-full shadow">
                    ‚ûï Qo‚Äòshish
                </button>`;
                    cameraList.appendChild(div);
                });

                data.cameras.forEach((cam, i) => {
                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50";
                    row.innerHTML = `
                <td class="p-2 border">${i + 1}</td>
                <td class="p-2 border">${cam.name}</td>
                <td class="p-2 border">${cam.type}</td>
                <td class="p-2 border">${cam.source}</td>
                <td class="p-2 border">
                    <span class="inline-block px-2 py-1 text-xs rounded-full ${cam.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${cam.is_active ? 'Faol' : 'Faol emas'}
                    </span>
                </td>
                <td class="p-2 border">
                    ${cam.selected ? '<span class="text-blue-600 text-xs font-medium">Tanlangan</span>' : '<span class="text-gray-400 text-xs">Yo‚Äòq</span>'}
                </td>
                <td class="p-2 border">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showCameraStream('${cam.source}')"
                            class="px-3 py-1 rounded-md text-xs font-medium border border-indigo-300 text-indigo-600 hover:bg-indigo-50">
                            Jonli ko‚Äòrish
                        </button>
                        <button onclick="toggleActive(${cam.id})"
                            class="px-3 py-1 rounded-md text-xs font-medium border border-gray-300 hover:bg-gray-100">
                            ${cam.is_active ? 'O‚Äòchirish' : 'Faollashtirish'}
                        </button>
                        <button onclick="selectCamera(${cam.id})"
                            class="px-3 py-1 rounded-md text-xs font-medium border border-blue-300 text-blue-600 hover:bg-blue-50">
                            Tanlash
                        </button>
                        <button onclick="deleteCamera(${cam.id})"
                            class="px-3 py-1 rounded-md text-xs font-medium border border-red-300 text-red-600 hover:bg-red-50">
                            O‚Äòchirish
                        </button>
                    </div>
                </td>
            `;
                    savedList.appendChild(row);
                });

                document.getElementById("cameraLoader").classList.add("hidden");
                cameraList.classList.remove("hidden");
            });
        });
        let clockInterval = null;

        function startClock(badgeElement) {
            if (clockInterval) clearInterval(clockInterval); // Eski intervalni to'xtatamiz

            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('uz-UZ', {hour12: false});
                badgeElement.textContent = timeString;
            }

            updateClock(); // Birinchi marta chaqiramiz
            clockInterval = setInterval(updateClock, 1000); // Har 1 sekundda yangilab turamiz
        }

        function openCameraModal(ip) {
            document.getElementById('cameraModal').classList.remove('hidden');
            document.getElementById('cameraForm').reset();
            document.getElementById('cameraIp').value = ip;
        }

        function closeCameraModal() {
            document.getElementById('cameraModal').classList.add('hidden');
        }

        function testLogin() {
            const ip = document.getElementById('cameraIp').value;
            const username = document.getElementById('cameraUsername').value;
            const password = document.getElementById('cameraPassword').value;
            const name = document.getElementById('cameraName').value;

            // Spinnerni ko‚Äòrsatish
            document.getElementById('modalLoader').classList.remove('hidden');

            fetch("/cameras/try-login/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ip, username, password})
            }).then(res => res.json()).then(response => {
                // Spinnerni yashirish
                document.getElementById('modalLoader').classList.add('hidden');

                if (response.status === "ok") {
                    saveCamera(ip, username, password, name);
                } else {
                    Swal.fire("‚ùå Xatolik", response.message, "error");
                }
            }).catch(err => {
                document.getElementById('modalLoader').classList.add('hidden');
                Swal.fire("‚ùå Xatolik", "Server bilan bog‚Äòlanishda xatolik", "error");
            });
        }

        function saveCamera(ip, username, password, name) {
            fetch("/cameras/save/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    name: name,
                    type: 'ip',
                    source: ip,
                    username: username,
                    password: password
                })
            }).then(res => res.json()).then(response => {
                if (response.status === "ok") {
                    Swal.fire("‚úÖ Muvaffaqiyatli", response.message, "success").then(() => location.reload());
                } else {
                    Swal.fire("‚ùå Xatolik", response.message, "error");
                }
            });
        }

        function filterCameras() {
            const search = document.getElementById('cameraSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.camera-card');
            cards.forEach(card => {
                const text = card.innerText.toLowerCase();
                card.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function toggleActive(id) {
            fetch(`/cameras/toggle/${id}/`, {
                method: "POST",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(res => res.json()).then(() => location.reload());
        }

        function selectCamera(id) {
            fetch(`/cameras/select/${id}/`, {
                method: "POST",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(res => res.json()).then(() => location.reload());
        }

        function deleteCamera(id) {
            Swal.fire({
                title: 'Ishonchingiz komilmi?',
                text: "Bu kamera o‚Äòchiriladi!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ha, o‚Äòchirish!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/cameras/delete/${id}/`, {
                        method: "POST",
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    }).then(res => res.json()).then(() => location.reload());
                }
            });
        }

        let currentSpeed = 1.0;
        let isPaused = true;

        // Play / Pause tugmasi
        function togglePlayPause() {
            const video = document.getElementById('streamFrameVideo');
            const playPauseButton = document.querySelector('#videoControls button:nth-child(2)');

            if (video.paused) {
                video.play();
                playPauseButton.textContent = '‚è∏'; // Pause belgisi
                isPaused = false;
            } else {
                video.pause();
                playPauseButton.textContent = '‚ñ∂Ô∏è'; // Play belgisi
                isPaused = true;
            }
        }

        // 10 sekund oldinga yoki orqaga o'tkazish
        function seekVideo(seconds) {
            const video = document.getElementById('streamFrameVideo');
            video.currentTime += seconds;
        }

        // Speed 0.5x / 1x / 2x aylantirish
        function toggleSpeed() {
            const video = document.getElementById('streamFrameVideo');
            const speedButton = document.querySelector('#videoControls button:nth-child(4)');

            if (currentSpeed === 1.0) {
                currentSpeed = 2.0;
            } else if (currentSpeed === 2.0) {
                currentSpeed = 0.5;
            } else {
                currentSpeed = 1.0;
            }

            video.playbackRate = currentSpeed;
            speedButton.textContent = `${currentSpeed}x`;
        }

        async function showCameraStream(ip, mode = "live", startTime = null, endTime = null) {
            console.log("\n================ üöÄ [showCameraStream] Boshlanishi ================\n");

            const host = window.location.hostname;
            const streamModal = document.getElementById('streamModal');
            const streamFrameImg = document.getElementById('streamFrameImg');
            const streamFrameVideo = document.getElementById('streamFrameVideo');
            const streamError = document.getElementById('streamError');
            const streamLoading = document.getElementById('streamLoading');
            const liveBadge = document.getElementById('liveBadge');
            const cameraNameBadge = document.getElementById('cameraNameBadge');
            const timeBadge = document.getElementById('timeBadge');

            try {
                const response = await fetch(`/cameras/edit/${ip}/`);
                const camera = await response.json();

                if (camera.status === 'error') {
                    console.error("‚ö†Ô∏è Kamera topilmadi.");
                    streamLoading.classList.add('hidden');
                    streamError.classList.remove('hidden');
                    streamModal.classList.remove('hidden');
                    return;
                }

                let streamUrl = "";
                if (mode === "live") {
                    streamUrl = `http://${host}:8000/cameras/live/${ip}/?username=${encodeURIComponent(camera.username)}&password=${encodeURIComponent(camera.password)}`;
                } else if (mode === "replay" && startTime && endTime) {
                    streamUrl = `http://${host}:8000/cameras/replay/${ip}/?username=${encodeURIComponent(camera.username)}&password=${encodeURIComponent(camera.password)}&start=${startTime}&end=${endTime}`;
                }

                console.log("üîó [STREAM] URL:", streamUrl);

                cameraNameBadge.textContent = camera.name || "Noma'lum Kamera";

                if (mode === "live") {
                    streamFrameImg.src = streamUrl;
                    streamFrameImg.classList.remove('hidden');
                    streamFrameVideo.classList.add('hidden');
                    liveBadge.classList.remove('hidden');
                    document.getElementById('videoControls').classList.add('hidden');

                    streamFrameImg.onload = () => {
                        streamLoading.classList.add('hidden');
                        streamError.classList.add('hidden');
                    };
                    streamFrameImg.onerror = () => {
                        streamLoading.classList.add('hidden');
                        streamError.classList.remove('hidden');
                    };

                } else {
                    streamFrameVideo.src = streamUrl;
                    streamFrameVideo.classList.remove('hidden');
                    streamFrameImg.classList.add('hidden');
                    liveBadge.classList.add('hidden');
                    document.getElementById('videoControls').classList.remove('hidden');

                    streamFrameVideo.load();
                    streamFrameVideo.onloadeddata = () => {
                        streamLoading.classList.add('hidden');
                        streamError.classList.add('hidden');
                    };
                    streamFrameVideo.onerror = () => {
                        streamLoading.classList.add('hidden');
                        streamError.classList.remove('hidden');
                    };
                }

                streamModal.classList.remove('hidden');
                streamLoading.classList.remove('hidden');
                startClock(timeBadge);

            } catch (error) {
                console.error("üí• [EXCEPTION] Xatolik yuz berdi:", error);
                streamLoading.classList.add('hidden');
                streamError.classList.remove('hidden');
                streamModal.classList.remove('hidden');
            }

            console.log("\n================ üöÄ [showCameraStream] Tugadi ================\n");
        }

        // Modalni yopish va tozalash
        function closeStreamModal() {
            const streamModal = document.getElementById('streamModal');
            const streamFrameImg = document.getElementById('streamFrameImg');
            const streamFrameVideo = document.getElementById('streamFrameVideo');
            const streamError = document.getElementById('streamError');
            const streamLoading = document.getElementById('streamLoading');

            // üî• Streamlarni tozalash
            if (streamFrameImg) {
                streamFrameImg.src = "";
                streamFrameImg.classList.add('hidden');
            }
            if (streamFrameVideo) {
                streamFrameVideo.pause();
                streamFrameVideo.src = "";
                streamFrameVideo.load();
                streamFrameVideo.classList.add('hidden');
            }

            // üî• Modal va xabarlarni yopish
            streamModal.classList.add('hidden');
            streamError.classList.add('hidden');
            streamLoading.classList.add('hidden');

            console.log("üìõ Stream modal tozalandi va yopildi.");
        }
    </script>
{% endblock %}
